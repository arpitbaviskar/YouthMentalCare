<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Youth Mental Wellness Companion</title>

  <style>
    :root {
      --primary-blue: #2563eb;
      --soft-blue: #e0f2fe;
      --dark-blue: #0f172a;
      --light-text: #e2e8f0;
      --warm-white: #f8fafc;
      --gentle-border: #334155;
      --success-green: #10b981;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, var(--dark-blue) 0%, #1e293b 100%);
      color: var(--light-text);
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 20px 0 30px;
      border-bottom: 1px solid var(--gentle-border);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2rem;
      margin: 0 0 10px;
      background: linear-gradient(45deg, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 1.1rem;
      margin-bottom: 15px;
    }

    .privacy-notice {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .privacy-icon {
      color: var(--success-green);
      font-size: 1.2rem;
    }

    .chat-container {
      flex: 1;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--gentle-border);
      border-radius: 16px;
      padding: 20px;
      height: 60vh;
      overflow-y: auto;
      scroll-behavior: smooth;
      margin-bottom: 20px;
    }

    .message {
      margin: 15px 0;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      max-width: 85%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      background: linear-gradient(135deg, var(--primary-blue), #3b82f6);
      color: white;
      margin-left: auto;
      text-align: right;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .message.assistant {
      background: rgba(148, 163, 184, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.2);
      margin-right: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message.thinking {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: #fbbf24;
      font-style: italic;
      margin-right: auto;
    }

    .input-area {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }

    .input-area input[type="text"] {
      flex: 1;
      padding: 16px 20px;
      border-radius: 12px;
      border: 1px solid var(--gentle-border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--light-text);
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
    }

    .input-area input[type="text"]:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-area input[type="text"]::placeholder {
      color: #64748b;
    }

    .send-button {
      padding: 16px 24px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, var(--primary-blue), #3b82f6);
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 80px;
    }

    .send-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
    }

    .send-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      text-align: center;
      color: #94a3b8;
      font-size: 0.9rem;
      margin-top: 15px;
      min-height: 20px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.4);
    }

    .footer-note {
      text-align: center;
      color: #64748b;
      font-size: 0.85rem;
      margin-top: 20px;
      line-height: 1.4;
    }

    /* Scrollbar styling */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 3px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.5);
    }

    /* Mobile responsiveness */
    @media (max-width: 640px) {
      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .chat-container {
        height: 50vh;
      }

      .message {
        max-width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Youth Mental Wellness Companion</h1>
      <p class="subtitle">A safe space for support and understanding</p>
      <div class="privacy-notice">
        <span class="privacy-icon">ðŸ”’</span>
        <div>
          <strong>Complete Privacy:</strong> All conversations happen locally on your device. 
          Nothing is stored, tracked, or sent anywhere. Your thoughts are yours alone.
        </div>
      </div>
    </header>

    <div id="chatContainer" class="chat-container">
      <div class="message assistant">
        Hi there! ðŸŒŸ I'm here to listen and offer gentle support. This is a safe space where you can share what's on your mind. 
        Whether you're feeling great, struggling, or somewhere in between - all feelings are welcome here. How are you doing today?
      </div>
    </div>

    <div class="input-area">
      <input 
        type="text" 
        id="userInput" 
        placeholder="Share what's on your mind..." 
        autocomplete="off"
        maxlength="500"
      />
      <button id="sendButton" class="send-button">Send</button>
    </div>

    <div id="statusMessage" class="status">Loading gentle AI support... First load may take a moment âœ¨</div>

    <div class="footer-note">
      ðŸ’™ Remember: This is supportive conversation, not professional therapy. For urgent concerns, 
      please reach out to a trusted adult, counselor, or crisis helpline.
    </div>
  </div>

  <!-- Transformers.js Integration -->
  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
    import { MENTAL_HEALTH_KB } from './mental_health_kb.js';

    let embedder = null;
    let kbEmbeddings = [];

    // Configure for browser-only usage
    env.allowLocalModels = false;
    env.allowRemoteModels = true;

    // DOM Elements
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const statusMessage = document.getElementById('statusMessage');

    // AI State Management
    let aiState = {
      sentimentAnalyzer: null,
      textGenerator: null,
      isReady: false,
      isInitializing: false
    };

    // Crisis Keywords - Immediate Safety Response
    const crisisKeywords = [
      'suicide', 'kill myself', 'end it all', 'hurt myself', 'self harm', 'self-harm',
      'want to die', 'better off dead', 'no point living', 'worthless life'
    ];

    // Enhanced Keyword Response System with Youth-Focused Language
    const mentalHealthResponses = {
      stress_academic: {
        keywords: ['stressed', 'assignments', 'homework', 'exams', 'deadlines', 'school pressure', 'studying', 'grades', 'tests'],
        responses: [
          "I understand that you may be feeling overwhelmed with your studies; it's okay to take a breath and find a moment of peace. School pressure is real, and many students feel this way. ðŸŒ¸",
          "Academic stress can feel heavy sometimes. You're not alone in this - many young people face similar pressures, and it's important to talk about them. Remember to be gentle with yourself. ðŸ’™",
          "It sounds like school is weighing on your mind. That's completely understandable - you're managing a lot! Taking small breaks and celebrating small wins can help. âœ¨",
          "Those academic pressures can feel intense. It's okay to feel overwhelmed sometimes - that shows you care about doing well. What matters most is taking care of yourself along the way. ðŸŒŸ"
        ]
      },

      anxiety_worry: {
        keywords: ['anxious', 'anxiety', 'worried', 'nervous', 'panic', 'scared', 'fear', 'overwhelming', 'can\'t handle'],
        responses: [
          "I hear that you're feeling anxious, and I want you to know that these feelings are valid. You're not alone in this - anxiety affects many young people, and it's brave of you to share. ðŸ¤—",
          "Anxiety can feel so overwhelming, but you're stronger than you know. It's okay to take things one moment at a time. Many young people experience these feelings, and talking about them helps. ðŸ’š",
          "Those anxious feelings sound really difficult right now. It's completely normal to feel this way sometimes - you're not alone, and it's important to be kind to yourself. ðŸŒ¿",
          "I understand that anxiety can feel consuming. Remember that you've gotten through difficult moments before, and you have that strength within you. Take a gentle breath with me. ðŸŒ¸"
        ]
      },

      sadness_depression: {
        keywords: ['sad', 'depressed', 'down', 'empty', 'hopeless', 'lonely', 'isolated', 'crying', 'tears', 'blue'],
        responses: [
          "I can hear that you're going through a really tough time, and I want you to know that your feelings matter. You're not alone - many young people experience these deep emotions. ðŸ’™",
          "It takes courage to share when you're feeling sad. These emotions are part of being human, and it's okay to feel them. You're not alone in this journey. ðŸ«‚",
          "I'm sorry you're feeling this way right now. Sadness can feel so heavy, but please know that you matter and these feelings can change. Many others have felt similar emotions. ðŸŒ™",
          "Your sadness is real and valid. It's okay to have days that feel darker - you don't have to carry this alone. Many young people understand these feelings. ðŸ’œ"
        ]
      },

      anger_frustration: {
        keywords: ['angry', 'mad', 'frustrated', 'irritated', 'furious', 'annoyed', 'rage', 'hate', 'unfair'],
        responses: [
          "I can feel the frustration in your words, and it's completely okay to feel angry sometimes. These emotions show that you care deeply about things. You're not alone in feeling this way. ðŸ”¥âž¡ï¸ðŸ’™",
          "Anger is a natural emotion, and it sounds like something really important to you has been affected. Many young people feel intense frustration - you're not alone in this. ðŸŒŸ",
          "It's okay to feel angry - these emotions are telling you something important. You're not alone in having strong feelings about things that matter to you. âš¡âž¡ï¸ðŸŒ¿",
          "Those frustrated feelings are completely valid. Sometimes anger shows us what we value most. Many young people experience these intense emotions - you're not alone. ðŸ’ª"
        ]
      },

      social_relationships: {
        keywords: ['friends', 'friendship', 'social', 'left out', 'rejected', 'bullying', 'peer pressure', 'fitting in', 'popularity'],
        responses: [
          "Social situations can be really challenging, especially during these important years. You're not alone - many young people struggle with similar relationship concerns. Your worth isn't defined by others. ðŸ¤",
          "I understand that social pressures can feel overwhelming. It's completely normal to worry about friendships and fitting in - you're not alone in these feelings. ðŸ’«",
          "Friendship and social dynamics can be so complex. Many young people share these same worries and experiences. Remember that authentic connections are what truly matter. ðŸŒŸ",
          "These social feelings are so common among young people - you're definitely not alone. It takes time to find your genuine connections, and that's perfectly okay. ðŸ’™"
        ]
      },

      self_esteem: {
        keywords: ['not good enough', 'ugly', 'stupid', 'failure', 'worthless', 'hate myself', 'insecure', 'confidence', 'self-doubt'],
        responses: [
          "I hear you being really hard on yourself, and I wish you could see yourself with more kindness. You're not alone - many young people struggle with these thoughts about themselves. You have worth. ðŸŒ¸",
          "Those self-critical thoughts sound so painful. Please know that you're not alone - many young people have similar struggles with self-worth. You deserve compassion, especially from yourself. ðŸ’œ",
          "It's heartbreaking to hear you speak about yourself this way. You're not alone in having these thoughts - they're more common than you might think. You are valuable just as you are. âœ¨",
          "Self-doubt can feel so overwhelming sometimes. Many young people experience these same difficult thoughts about themselves. You're worthy of love and kindness - including from yourself. ðŸŒŸ"
        ]
      },

      family_home: {
        keywords: ['parents', 'family', 'home', 'siblings', 'fighting', 'divorce', 'family problems', 'misunderstood'],
        responses: [
          "Family situations can be really complicated and emotionally challenging. You're not alone - many young people face difficult family dynamics. Your feelings about this are completely valid. ðŸ ðŸ’™",
          "I can hear that things at home are tough right now. Family relationships can be so complex - you're not alone in struggling with these dynamics. ðŸ¤—",
          "Family challenges can affect us deeply, and it's completely understandable that you're feeling this way. Many young people experience similar family difficulties. ðŸ’œ",
          "Home should feel safe, and I'm sorry if it doesn't always feel that way. You're not alone - many young people navigate complex family relationships. Your feelings matter. ðŸŒŸ"
        ]
      },

      positive_emotions: {
        keywords: ['happy', 'good', 'great', 'excited', 'proud', 'accomplished', 'joy', 'celebration', 'success'],
        responses: [
          "It's wonderful to hear some positivity in your message! ðŸŒŸ It's important to celebrate these good moments - they matter just as much as the challenging ones. You're not alone in experiencing joy! âœ¨",
          "I love hearing when things are going well for you! These positive feelings are just as important to acknowledge. Many young people find strength in celebrating the good moments. ðŸŽ‰",
          "Your happiness is contagious! It's beautiful to hear you sharing positive emotions. Remember to hold onto these feelings - they're proof that good moments do exist. ðŸ’«",
          "What a bright spot in the day! Positive emotions deserve just as much attention as difficult ones. Many young people benefit from acknowledging and celebrating their good moments. ðŸŒˆ"
        ]
      },

      general_support: {
        keywords: ['tired', 'exhausted', 'overwhelmed', 'confused', 'lost', 'don\'t know', 'help', 'support'],
        responses: [
          "It sounds like you're carrying a lot right now, and that exhaustion is completely understandable. You're not alone - many young people feel overwhelmed sometimes. It's okay to rest. ðŸŒ™",
          "I can hear that things feel really heavy right now. You're not alone in feeling this way - many young people experience these overwhelming moments. Take it one step at a time. ðŸ’™",
          "Feeling lost or confused is such a normal part of growing up, even though it doesn't feel normal when you're in it. You're not alone in navigating these uncertain feelings. ðŸ§­",
          "It takes strength to reach out when you're struggling. You're not alone - many young people share similar feelings of uncertainty. You don't have to figure everything out right now. âœ¨"
        ]
      }
    };

    // Crisis Response
    function getCrisisResponse() {
      return `ðŸš¨ I'm very concerned about what you've shared. Your safety is the most important thing right now.

Please reach out for immediate support:
â€¢ Crisis Text Line: Text HOME to 741741
â€¢ National Suicide Prevention Lifeline: 988
â€¢ Or speak with a trusted adult, counselor, or go to your nearest emergency room

You don't have to face this alone. There are people who want to help. ðŸ’œ`;
    }

    // Check for crisis keywords
    function containsCrisisLanguage(text) {
      const lowerText = text.toLowerCase();
      return crisisKeywords.some(keyword => lowerText.includes(keyword));
    }

    // Enhanced keyword matching with youth-focused responses
    function getKeywordResponse(text) {
      const lowerText = text.toLowerCase();

      // Find the best matching category
      for (const [category, data] of Object.entries(mentalHealthResponses)) {
        const matchedKeywords = data.keywords.filter(keyword => lowerText.includes(keyword));
        if (matchedKeywords.length > 0) {
          // Return a random response from the matching category
          const randomIndex = Math.floor(Math.random() * data.responses.length);
          return data.responses[randomIndex];
        }
      }

      // Default supportive response if no specific keywords match
      const defaultResponses = [
        "Thank you for sharing with me. I'm here to listen, and you're not alone in whatever you're experiencing. Many young people go through similar feelings. ðŸ’™",
        "I appreciate you opening up. Whatever you're going through, please know that you're not alone - many young people share similar experiences and feelings. ðŸŒŸ",
        "It means a lot that you're sharing your thoughts here. You're not alone - many young people find it helpful to talk about what's on their mind. I'm here to listen. ðŸ¤—",
        "Thank you for trusting me with your feelings. Remember that you're not alone in whatever you're experiencing. Many young people find comfort in knowing they're heard. âœ¨"
      ];

      return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
    }

    // AI-Enhanced Response Generation
    async function generateAIEnhancedResponse(userText) {
      if (!aiState.isReady || !aiState.sentimentAnalyzer) {
        return getKeywordResponse(userText);
      }

      try {
        // Analyze sentiment
        const sentimentResult = await aiState.sentimentAnalyzer(userText);
        const sentiment = sentimentResult[0];

        // Get base keyword response
        let baseResponse = getKeywordResponse(userText);

        // If we have a text generator, try to enhance the response
        if (aiState.textGenerator) {
          try {
            const prompt = sentiment.label === 'NEGATIVE' 
              ? "Write one supportive, warm sentence for a young person who is struggling (no advice, just empathy): "
              : "Write one encouraging, kind sentence for a young person (no advice, just support): ";

            const generated = await aiState.textGenerator(prompt, {
              max_length: 60,
              temperature: 0.8,
              do_sample: true,
              num_return_sequences: 1
            });

            if (generated && generated[0] && generated[0].generated_text) {
              let enhancedText = generated[0].generated_text
                .replace(prompt, '')
                .trim();

              // Quality check: ensure it's appropriate and not too short
              if (enhancedText.length > 25 && 
                  !enhancedText.includes('diagnose') && 
                  !enhancedText.includes('prescribe') &&
                  !enhancedText.includes('therapy')) {
                // Combine AI-generated empathy with keyword-based response
                return enhancedText + " " + baseResponse.split('.')[0] + ". ðŸ’™";
              }
            }
          } catch (genError) {
            console.log('Generation enhancement failed, using keyword response');
          }
        }
    console.log("Returning base keyword response as fallback");
    return baseResponse;
  } catch (error) {
    console.log('AI processing failed, using keyword response');
    const fallbackResponse = getKeywordResponse(userText);
    console.log("Fallback keyword response:", fallbackResponse);
    return fallbackResponse;
  }
}

    // Initialize AI Models
    async function initializeAI() {
      if (aiState.isInitializing) return;
      aiState.isInitializing = true;

      try {
        statusMessage.textContent = "Loading empathy models locally... ðŸ§ âœ¨";

        // Load sentiment analysis first (smaller, faster)
        aiState.sentimentAnalyzer = await pipeline(
          'sentiment-analysis',
          'Xenova/distilbert-base-uncased-finetuned-sst-2-english'
        );

        statusMessage.textContent = "Sentiment understanding ready! Loading response enhancement... ðŸ’«";

        // Load text generation (optional enhancement)
        setTimeout(async () => {
          try {
            aiState.textGenerator = await pipeline(
              'text-generation',
              'Xenova/distilgpt2'
            );
            statusMessage.textContent = "AI companion fully loaded! All processing stays private on your device ðŸ”’âœ¨";
          } catch (genError) {
            statusMessage.textContent = "Core AI ready! (Enhanced generation unavailable, but keyword responses work great) ðŸ’™";
          }
        }, 1000);

        aiState.isReady = true;
      } catch (error) {
        console.error('AI initialization failed:', error);
        aiState.isReady = false;
        statusMessage.textContent = "Using thoughtful keyword responses (AI unavailable, but still fully private!) ðŸ’™";
      } finally {
        aiState.isInitializing = false;
      }
    }

    // UI Helper Functions
    function addMessage(sender, content, isThinking = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}${isThinking ? ' thinking' : ''}`;
      messageDiv.innerHTML = content;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return messageDiv;
    }

    function removeMessage(messageElement) {
      if (messageElement && messageElement.parentNode) {
        messageElement.parentNode.removeChild(messageElement);
      }
    }

    // Main Message Handler
    async function handleUserMessage() {
      const userText = userInput.value.trim();
      if (!userText) return;

      // Add user message
      addMessage('user', userText);

      // Clear input and disable controls
      userInput.value = '';
      sendButton.disabled = true;
      userInput.disabled = true;

      // Show thinking indicator
      const thinkingMessage = addMessage('assistant', 'ðŸ’­ Understanding your feelings...', true);

      try {
        let response;

        // Crisis check first (always highest priority)
        if (containsCrisisLanguage(userText)) {
          response = getCrisisResponse();
        } else {
          // Generate supportive response
          response = await generateAIEnhancedResponse(userText);
        }

        // Remove thinking message and add actual response
        removeMessage(thinkingMessage);
        addMessage('assistant', response);

      } catch (error) {
        console.error('Error generating response:', error);
        removeMessage(thinkingMessage);
        addMessage('assistant', "I'm here with you, even if I'm having trouble finding the right words right now. Your feelings are valid, and you're not alone. ðŸ’™");
      } finally {
        // Re-enable controls
        sendButton.disabled = false;
        userInput.disabled = false;
        userInput.focus();
      }
    }

    // Event Listeners
    sendButton.addEventListener('click', handleUserMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleUserMessage();
      }
    });

    // Auto-focus input
    userInput.focus();

    // Initialize AI on page load
    initializeAI();

    // Provide encouraging status updates
    setTimeout(() => {
      if (!aiState.isReady && statusMessage.textContent.includes('Loading')) {
        statusMessage.textContent = "Still loading... but keyword responses are ready and caring! ðŸ’™";
      }
    }, 10000);
  </script>
</body>

</html>
