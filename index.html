<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Youth Mental Wellness Chat</title>

  <style>
    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: Inter, Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: #fff;
      background: radial-gradient(1200px 600px at 10% 10%, #1f2a44 0%, #161922 40%, #0f1218 100%) no-repeat fixed;
    }

    .header { text-align: center; padding: 24px 16px 8px; }
    .header h1 { margin: 0 0 6px; font-size: 28px; color: #3d97c7; }
    .header p { margin: 0 0 10px; color: #e8f2ffcc; }
    .header-actions { display: flex; gap: 12px; justify-content: center; align-items: center; }

    .link { color: #8cc9ff; text-decoration: none; border-bottom: 1px dotted #8cc9ff66; }
    .link:hover { color: #b7ddff; }

    .clear-btn {
      background: #223049; color: #dcecff; border: 1px solid #3a4f72;
      border-radius: 8px; padding: 6px 10px; cursor: pointer;
    }
    .clear-btn:hover { background: #2a3a58; }

    .container {
      width: 100%;
      max-width: 760px;
      margin: 0 auto 24px;
      background: rgba(26, 31, 46, 0.8);
      border: 1px solid #233049;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }

    /* Button group */
    .button-group { display: flex; gap: 8px; margin-bottom: 8px; }
    .mode-btn {
      flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #2f4668;
      background: #172033; color: #cee6ff; cursor: pointer;
    }
    .mode-btn.active { background: #3d97c7; color: #041423; border-color: #63b7e6; }
    .mode-btn:focus-visible { outline: 2px solid #8cc9ff; outline-offset: 2px; }

    /* Mood tracker */
    .mood-tracker { margin-bottom: 10px; }
    .mood-label { margin: 0 0 6px; color: #cfe6ffcc; }
    .mood-options { display: flex; gap: 8px; flex-wrap: wrap; }
    .mood-chip {
      background: #172033; color: #d6e8ff; border: 1px solid #2f4668; border-radius: 999px;
      padding: 6px 10px; cursor: pointer;
    }
    .mood-chip.selected { background: #285a83; border-color: #3d97c7; }
    .mood-chip:focus-visible { outline: 2px solid #8cc9ff; outline-offset: 2px; }

    /* Chat */
    .chat-box { display: flex; flex-direction: column; gap: 8px; }

    .messages {
      max-height: 52vh; overflow-y: auto; padding: 8px; border-radius: 12px;
      background: #131727; border: 1px solid #232a45;
    }

    .message { padding: 10px 12px; margin: 8px 0; border-radius: 12px; max-width: 85%; }
    .message.user { background: #3d97c7; color: #02101c; margin-left: auto; }
    .message.ai { background: #1f2532; color: #eaf3ff; margin-right: auto; }
    .meta { font-size: 11px; opacity: 0.75; margin-top: 6px; display: flex; gap: 8px; }
    .safety-flag { color: #ffb3b3; background: #3a1212; padding: 1px 6px; border-radius: 6px; border: 1px solid #6d2a2a; }
    .typing { color: #b7ddff; font-size: 13px; opacity: 0.9; }

    .error {
      display: none; background: #341a1a; color: #ffdede; border: 1px solid #5a2b2b;
      padding: 8px 10px; border-radius: 8px;
    }

    .input-row { display: flex; gap: 8px; align-items: flex-end; }
    .chat-input {
      flex: 1; background: #0f1524; color: #eaf3ff; border: 1px solid #2c385a;
      border-radius: 10px; padding: 10px 12px; resize: vertical;
    }
    .chat-input::placeholder { color: #93a8c7; }

    .send-btn {
      background: #3d97c7; color: #041423; border: 1px solid #63b7e6;
      border-radius: 10px; padding: 10px 14px; cursor: pointer; min-width: 80px;
    }
    .send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .send-btn:focus-visible { outline: 2px solid #8cc9ff; outline-offset: 2px; }

    .disclaimer { color: #9fb8d7; font-size: 12px; text-align: center; margin: 4px 0 0; }

    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0,0,0,0); border: 0;
    }

    @media (max-width: 600px) {
      .container { padding: 12px; border-radius: 12px; }
      .messages { max-height: 58vh; }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Youth Mental Wellness</h1>
    <p>Choose to talk or receive gentle suggestions, in a calm, supportive space.</p>
    <div class="header-actions">
      <a class="link" href="#" id="privacyLink">Privacy Disclaimer</a>
      <button class="clear-btn" id="clearBtn">Clear chat</button>
    </div>
  </header>

  <main class="container">
    <section aria-label="mode selection" class="button-group" role="group">
      <button id="modeListen" class="mode-btn active" aria-pressed="true">Just listen</button>
      <button id="modeSuggest" class="mode-btn" aria-pressed="false">Give suggestions</button>
    </section>

    <section class="mood-tracker" aria-label="mood selector">
      <p class="mood-label">How are you feeling?</p>
      <div class="mood-options" role="radiogroup">
        <button class="mood-chip selected" role="radio" aria-checked="true" data-mood="neutral">Neutral</button>
        <button class="mood-chip" role="radio" aria-checked="false" data-mood="happy">Happy</button>
        <button class="mood-chip" role="radio" aria-checked="false" data-mood="anxious">Anxious</button>
        <button class="mood-chip" role="radio" aria-checked="false" data-mood="sad">Sad</button>
        <button class="mood-chip" role="radio" aria-checked="false" data-mood="angry">Angry</button>
        <button class="mood-chip" role="radio" aria-checked="false" data-mood="tired">Tired</button>
      </div>
    </section>

    <section class="chat-box" aria-label="chat">
      <div id="messages" class="messages" aria-live="polite" aria-relevant="additions"></div>

      <div id="error" class="error" role="alert"></div>

      <div class="input-row">
        <label class="sr-only" for="chatInput">Type a message</label>
        <textarea id="chatInput" class="chat-input" rows="2" placeholder="Share what’s on your mind…"></textarea>
        <button id="sendBtn" class="send-btn">Send</button>
      </div>

      <p class="disclaimer">This chat is not a medical service. For emergencies in India: Kiran 1800-599-0019, AASRA +91-9820466726, iCall +91-9152987821.</p>
    </section>
  </main>

  <script>
    // app.js — Static, local scripted replies (expanded Listen + Suggestions)
    const API_BASE = '/.netlify/functions'; // reserved

    // ---------- UI element hooks ----------
    const els = {
      privacyLink: document.getElementById('privacyLink'),
      clearBtn: document.getElementById('clearBtn'),
      modeListen: document.getElementById('modeListen'),
      modeSuggest: document.getElementById('modeSuggest'),
      moodChips: document.querySelectorAll('.mood-chip'),
      messages: document.getElementById('messages'),
      error: document.getElementById('error'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn')
    };

    // ---------- App state ----------
    let state = {
      mode: 'listen', // 'listen' | 'suggestions'
      mood: 'neutral',
      loading: false,
      history: []
    };

    // ---------- Persistence ----------
    function save() {
      try {
        localStorage.setItem('ymw_history', JSON.stringify(state.history));
        localStorage.setItem('ymw_mood', state.mood);
        localStorage.setItem('ymw_mode', state.mode);
      } catch {}
    }

    function load() {
      try {
        const h = JSON.parse(localStorage.getItem('ymw_history') || '[]');
        const mood = localStorage.getItem('ymw_mood') || 'neutral';
        const mode = localStorage.getItem('ymw_mode') || 'listen';
        state.history = Array.isArray(h) ? h : [];
        state.mood = mood;
        state.mode = mode;
        setMode(mode);
        setMood(mood);
        render();
      } catch {}
    }

    // ---------- Mode / Mood ----------
    function setMode(mode) {
      state.mode = mode;
      els.modeListen.classList.toggle('active', mode === 'listen');
      els.modeListen.setAttribute('aria-pressed', String(mode === 'listen'));
      els.modeSuggest.classList.toggle('active', mode === 'suggestions');
      els.modeSuggest.setAttribute('aria-pressed', String(mode === 'suggestions'));
      els.chatInput.placeholder = mode === 'listen'
        ? 'Share what’s on your mind…'
        : 'Describe what you’d like suggestions for…';
      save();
    }

    function setMood(mood) {
      state.mood = mood;
      els.moodChips.forEach(chip => {
        const selected = chip.dataset.mood === mood;
        chip.classList.toggle('selected', selected);
        chip.setAttribute('aria-checked', String(selected));
      });
      save();
    }

    // ---------- Render ----------
    function addMessage({ type, text, time = Date.now(), safety = null }) {
      state.history.push({ type, text, time, safety });
      render();
      save();
    }

    function messageHTML(m) {
      const ts = new Date(m.time).toLocaleTimeString();
      const safe = m.safety && m.safety.blocked ? '<span class="safety-flag">safety</span>' : '';
      const esc = escapeHTML(m.text);
      const who = m.type === 'user' ? 'user' : 'ai';
      return `
        <div class="message ${who}">
          <div>${esc}</div>
          <div class="meta">
            <span>${ts}</span>
            ${safe}
          </div>
        </div>
      `;
    }

    function render() {
      els.messages.innerHTML = state.history.map(messageHTML).join('');
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function escapeHTML(str) {
      return (str || '').replace(/[&<>"']/g, s => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[s]);
    }

    // ---------- Local Scripted Responses Engine (expanded Listen + Suggestions) ----------
    const CLUSTERS = [
      {
        id: 'academic_load',
        keywords: ['exam','exams','test','tests','deadline','deadlines','assignment','assignments','backlog','grade','grades','cgpa','fail','failing','attendance','viva','submission','thesis','project'],
        listen: [
          "That sounds like a lot to carry. When work stacks up it’s natural to feel heavy. If it’s okay, which bit feels most stuck right now—getting started, understanding a part, or the time pressure?",
          "Hearing this, it seems the effort matters to self even if the result isn’t there yet. What’s one tiny piece that feels least overwhelming to talk through first?",
          "It makes sense to feel low with deadlines hovering. If the assignment could talk, what would it be asking for in one sentence?",
          "Thanks for sharing this—it takes courage. Would it help to zoom in on just today: what would ‘good enough for today’ look like in one small step?"
        ],
        suggest: [
          "Let’s make this gentler and doable: set a 10‑minute timer and write only the outline—no full sentences, just bullets. Then pick one bullet and draft two ugly lines for it. After that, take 3 deep breaths, sip water, and decide if a second 10‑minute round feels okay.",
          "Try a ‘one‑question unlock’: message a peer/TA with a single clear doubt. While waiting, create a tiny sandbox file to prototype the hardest part for 10 minutes. The goal isn’t perfect—just prove one small thing works.",
          "Work backward from ‘submit’ to now: (a) final export/checklist, (b) polish pass, (c) core content, (d) outline. Start at (d) today with a strict 20‑minute cap. If stuck, speak the outline out loud and transcribe—it’s quicker than typing from zero.",
          "Use two tracks: Track A (must‑have): meet the rubric basics. Track B (nice‑to‑have): one enhancement if time remains. Finish Track A first in a 25‑minute block; consider Track B only if energy allows.",
          "Match energy: low—7 minutes setup (open files, make headings); medium—intro + one body paragraph; high—results/analysis. Each level counts as real progress.",
          "Body‑double focus: co‑work with a friend for 30 minutes (mics off), then share one sentence on progress. Light social presence often unlocks focus.",
          "Rubric‑first: extract the top 3 scoring criteria and make a mini checklist. Work only on those for 30 minutes; park everything else in a later list.",
          "First ugly draft: write as if no one will read it; drop [XX] where stuck and keep moving. After 20 minutes, search [XX] and fill only the easy ones.",
          "Playful constraint: draft each paragraph with exactly 3 sentences on the first pass to reduce overthinking; structure can be fixed later.",
          "Micro‑deadlines ladder: T+15 outline, T+40 section 1, T+70 section 2. At each alarm, spend 2 minutes choosing the next smallest step—no self‑critique.",
          "Mirror a good example’s headings and replace content with quick notes about yours. Scaffolds cut decision fatigue.",
          "Run two pomodoros with different themes: P1 ‘collect’ (references/snippets), P2 ‘compose’ (turn bits into sentences). Keep them strictly separate.",
          "If anxiety spikes: 90‑second reset—feet on floor, longer exhale than inhale, name 3 objects in sight. Then write one sentence that moves the task forward.",
          "Peer shortcut: send a 4‑bullet status to a classmate asking for just one suggestion. Lower ask = faster help.",
          "Time‑boxed polish: finish a rough draft first; then 12 minutes only for clarity/grammar. Submit the draft that exists rather than chase a perfect one that doesn’t."
        ]
      },
      {
        id: 'procrastination_focus',
        keywords: ['procrastinate','procrastination','can’t start','cant start','delay','postpone','late','scroll','doomscroll','distract','distraction','focus','concentrate','phone','youtube','instagram','reel','shorts'],
        listen: [
          "Starting can feel like pushing a boulder. No shame in that. What usually helps a little—short timers, a buddy on call, or removing one distraction?",
          "It’s okay if motivation is missing; momentum often arrives after the first tiny move. What would a 2‑minute ‘just open it’ step look like?",
          "Sounds like a tug‑of‑war between intentions and energy. If we picked the easiest possible start, what would that be?",
          "Thanks for being honest—it’s relatable. Would a small experiment for the next 10 minutes feel manageable?"
        ],
        suggest: [
          "Start with a ‘setup only’ ritual for 5 minutes: open files, title the doc, list 3 micro‑tasks. Momentum beats motivation.",
          "Put the phone in another room for 25 minutes; leave a sticky note near it that says ‘one small step finished’ to reward retrieval after the block.",
          "Use the 3‑tab rule: editor, reference, and task list only. Anything else goes to a ‘parked ideas’ note to review later.",
          "Do a 2‑minute countdown and begin on ‘1’ no matter what. Starting friction often drops once in motion.",
          "Try a 10‑minute ‘voice draft’: speak thoughts into a voice note or speech‑to‑text, then clean it up. Talking is faster than typing when stuck.",
          "Set a tiny consequence/reward pair: if the 20‑minute block completes, watch one short clip or have a snack; if not, do 10 squats and restart—keep it playful.",
          "Replace ‘finish task’ with ‘work on task for 12 minutes.’ Duration goals are kinder than outcome goals.",
          "Use the visible timer trick: keep a countdown on screen and commit to not switching apps until it dings."
        ]
      },
      // ... The remaining clusters from app.js continue unchanged ...
      // To keep the document concise, include all remaining cluster objects here
      // exactly as in your original app.js file.
    ];

    // ---------- Safety ----------
    function localRisk(text) {
      const t = (text||'').toLowerCase();
      const selfHarm = /(suicide|kill myself|end my life|self-harm|cutting|no reason to live)/i.test(t);
      const harmOthers = /(kill (him|her|them|someone)|hurt others|violent revenge)/i.test(t);
      return { selfHarm, harmOthers, acute: false };
    }
    function crisisLocalMessage() {
      return "It sounds like this might be a crisis. If there’s any immediate danger, contact local emergency services now. India resources: Kiran Helpline 1800-599-0019, AASRA +91-9820466726, iCall +91-9152987821.";
    }

    // ---------- Classification + selection ----------
    function classify(text) {
      const t = (text||'').toLowerCase();
      let best = { id: 'general_support', score: 0 };
      for (const c of CLUSTERS) {
        let score = 0;
        for (const k of c.keywords) {
          if (t.includes(k)) score += Math.min(3, Math.floor(k.length/4));
        }
        if (score > best.score) best = { id: c.id, score };
      }
      return best.id;
    }

    function scriptedTemplate(clusterId, mode) {
      const c = CLUSTERS.find(x => x.id === clusterId);
      if (!c) {
        return mode === 'listen'
          ? "Thanks for sharing this. It sounds important and heavy. What part feels most present right now?"
          : "Here are two gentle options: write the problem in one sentence, then take a 10‑minute action toward it. If energy is low, it’s okay to pause and return later.";
      }
      const arr = mode === 'listen' ? c.listen : c.suggest;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function localScriptReply({ text, mode }) {
      const risk = localRisk(text);
      if (risk.selfHarm || risk.harmOthers) {
        return { message: crisisLocalMessage(), safety: { risk, blocked: true } };
      }
      const clusterId = classify(text);
      const msg = scriptedTemplate(clusterId, mode);
      return {
        message: msg,
        safety: { risk: { selfHarm:false, harmOthers:false, acute:false }, blocked: false },
        clusterId
      };
    }

    // ---------- Send (local) ----------
    async function send() {
      const text = els.chatInput.value.trim();
      if (!text || state.loading) return;
      hideError();
      addMessage({ type: 'user', text });
      els.chatInput.value = '';
      state.loading = true;

      const typing = document.createElement('div');
      typing.className = 'typing';
      typing.textContent = 'AI is typing…';
      els.messages.appendChild(typing);
      els.messages.scrollTop = els.messages.scrollHeight;

      try {
        const data = localScriptReply({ text, mode: state.mode });
        const aiText = data.message;
        addMessage({ type: 'ai', text: aiText, safety: data.safety });
      } catch (e) {
        showError(String(e.message || e));
        addMessage({ type: 'ai', text: 'Sorry, there was a problem reaching the service. Please try again.' });
      } finally {
        state.loading = false;
        typing.remove();
      }
    }

    // ---------- Errors ----------
    function showError(msg) {
      els.error.textContent = msg;
      els.error.style.display = 'block';
    }
    function hideError() {
      els.error.style.display = 'none';
      els.error.textContent = '';
    }

    // ---------- Events ----------
    els.modeListen.addEventListener('click', () => setMode('listen'));
    els.modeSuggest.addEventListener('click', () => setMode('suggestions'));
    els.moodChips.forEach(chip => chip.addEventListener('click', () => setMood(chip.dataset.mood)));
    els.sendBtn.addEventListener('click', send);
    els.chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); send();
      }
    });
    els.clearBtn.addEventListener('click', () => {
      state.history = []; save(); render();
    });
    els.privacyLink.addEventListener('click', (e) => {
      e.preventDefault();
      alert('This chat is not a medical service. Avoid sharing personal identifiers. For emergencies in India: Kiran 1800-599-0019, AASRA +91-9820466726, iCall +91-9152987821.');
    });

    // ---------- Init ----------
    load();
  </script>
</body>
</html>

